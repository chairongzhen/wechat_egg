<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <title>亮度设置</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
    <link rel="stylesheet" href="/public/css/weui.css" />
    <link rel="stylesheet" href="/public/css/weui2.css" />
    <link rel="stylesheet" href="/public/css/slider.css" />
    <script src="/public/js/zepto.min.js"></script>
    <script src="/public/js/picker.js"></script>
    <script src="/public/js/RangeSlider.js"></script>

<body ontouchstart style="background-color: #f8f8f8;">
    <script type="text/javascript">
        let signature = '{{ machineinfo.signature }}';
        let nonceStr = '{{ machineinfo.noncestr }}';
        let timestamp = '{{ machineinfo.timestamp }}';
        let appId = '{{ machineinfo.appId }}';
        let jsapi_ticket = '{{ machineinfo.jsapi_ticket }}';
    </script>
    <div class="page-hd">
        <h1 class="page-hd-title">
            亮度设置
        </h1>
        <p class="page-hd-desc">设定选择时间点时亮度;亮度范围(0-100%)</p>
    </div>
    <form id="form">
        <div class="weui_cells weui_cells_form ">
            <div class="weui_cell">
                <div class="weui_cell_hd"><label for="" class="weui_label">时间点</label></div>
                <div class="weui_cell_bd weui_cell_primary">
                    <input type="hidden" id="hidselecttimepoint" />
                    <input class="weui_input" type="text" onchange="tagchange();" value="" id='selecttimepoint' />
                </div>
            </div>

            <div class="weui_cell">
                <div class="weui_cell_hd"><label for="" class="weui_label">第一排:</label></div>
                <div class="weui_cell_bd weui_cell_primary">
                    <input type="range" name="points" min="0" max="100" step="any" id="rangerl1" />
                    <input type="number" onchange="txtl1change();" value="100" id="txtl1" style="width:30px; height:20px; text-align:center; vertical-align:-webkit-baseline-middle" />
                </div>
            </div>
            <div class="weui_cell">
                <div class="weui_cell_hd"><label for="" class="weui_label">第二排:</label></div>
                <div class="weui_cell_bd weui_cell_primary">
                    <input type="range" name="points" min="0" max="100" step="any" id="rangerl2" />
                    <input type="number" onchange="txtl2change();" id="txtl2" style="width:30px; height:20px; text-align:center; vertical-align:-webkit-baseline-middle" />
                </div>
            </div>
            <div class="weui_cell">
                <div class="weui_cell_hd"><label for="" class="weui_label">第三排:</label></div>
                <div class="weui_cell_bd weui_cell_primary">
                    <input type="range" name="points" min="0" max="100" step="any" id="rangerl3" />
                    <input type="number" onchange="txtl3change();" id="txtl3" style="width:30px; height:20px; text-align:center; vertical-align:-webkit-baseline-middle" />
                </div>
            </div>
            <div class="weui_cell">
                <div class="weui_cell_hd"><label for="" class="weui_label">第四排:</label></div>
                <div class="weui_cell_bd weui_cell_primary">
                    <input type="range" name="points" min="0" max="100" step="any" id="rangerl4" />
                    <input type="number" onchange="txtl4change();" id="txtl4" style="width:30px; height:20px; text-align:center; vertical-align:-webkit-baseline-middle" />
                </div>
            </div>
            <div class="weui_cell">
                <div class="weui_cell_hd"><label for="" class="weui_label">第五排:</label></div>
                <div class="weui_cell_bd weui_cell_primary">
                    <input type="range" name="points" min="0" max="100" step="any" id="rangerl5" />
                    <input type="number" onchange="txtl5change();" id="txtl5" style="width:30px; height:20px; text-align:center; vertical-align:-webkit-baseline-middle" />
                </div>
            </div>
            <div class="weui_cell">
                <div class="weui_cell_hd"><label for="" class="weui_label">第六排:</label></div>
                <div class="weui_cell_bd weui_cell_primary">
                    <input type="range" name="points" min="0" max="100" step="any" id="rangerl6" />
                    <input type="number" onchange="txtl6change();" id="txtl6" style="width:30px; height:20px; text-align:center; vertical-align:-webkit-baseline-middle" />
                </div>
            </div>
            <div class="weui_cell">
                <div class="weui_cell_hd"><label for="" class="weui_label">第七排:</label></div>
                <div class="weui_cell_bd weui_cell_primary">
                    <input type="range" name="points" min="0" max="100" step="any" id="rangerl7" />
                    <input type="number" onchange="txtl7change();" id="txtl7" style="width:30px; height:20px; text-align:center; vertical-align:-webkit-baseline-middle" />
                </div>
            </div>
        </div>

        <div class="weui_btn_area">
            <a id="btnsave" class="weui_btn weui_btn_primary" onclick="save();">保存</a>
            <a id="btnback" class="weui_btn weui_btn_default" onclick="back();">返回</a>
        </div>
    </form>
    <script>
        let TIMEDEFINE =
            ["0:00", "0:10", "0:20", "0:30", "0:40", "0:50",
                "1:00", "1:10", "1:20", "1:30", "1:40", "1:50",
                "2:00", "2:10", "2:20", "2:30", "2:40", "2:50",
                "3:00", "3:10", "3:20", "3:30", "3:40", "3:50",
                "4:00", "4:10", "4:20", "4:30", "4:40", "4:50",
                "5:00", "5:10", "5:20", "5:30", "5:40", "5:50",
                "6:00", "6:10", "6:20", "6:30", "6:40", "6:50",
                "7:00", "7:10", "7:20", "7:30", "7:40", "7:50",
                "8:00", "8:10", "8:20", "8:30", "8:40", "8:50",
                "9:00", "9:10", "9:20", "9:30", "9:40", "9:50",
                "10:00", "10:10", "10:20", "10:30", "10:40", "10:50",
                "11:00", "11:10", "11:20", "11:30", "11:40", "11:50",
                "12:00", "12:10", "12:20", "12:30", "12:40", "12:50",
                "13:00", "13:10", "13:20", "13:30", "13:40", "13:50",
                "14:00", "14:10", "14:20", "14:30", "14:40", "14:50",
                "15:00", "15:10", "15:20", "15:30", "15:40", "15:50",
                "16:00", "16:10", "16:20", "16:30", "16:40", "16:50",
                "17:00", "17:10", "17:20", "17:30", "17:40", "17:50",
                "18:00", "18:10", "18:20", "18:30", "18:40", "18:50",
                "19:00", "19:10", "19:20", "19:30", "19:40", "19:50",
                "20:00", "20:10", "20:20", "20:30", "20:40", "20:50",
                "21:00", "21:10", "21:20", "21:30", "21:40", "21:50",
                "22:00", "22:10", "22:20", "22:30", "22:40", "22:50",
                "23:00", "23:10", "23:20", "23:30", "23:40", "23:50"
            ];


        $.fn.RangeSlider = function (cfg) {
            this.sliderCfg = {
                min: cfg && !isNaN(parseFloat(cfg.min)) ? Number(cfg.min) : null,
                max: cfg && !isNaN(parseFloat(cfg.max)) ? Number(cfg.max) : null,
                step: cfg && Number(cfg.step) ? cfg.step : 1,
                callback: cfg && cfg.callback ? cfg.callback : null
            };

            var $input = $(this);
            var min = this.sliderCfg.min;
            var max = this.sliderCfg.max;
            var step = this.sliderCfg.step;
            var callback = this.sliderCfg.callback;

            $input.attr('min', min)
                .attr('max', max)
                .attr('step', step);

            $input.bind("input", function (e) {
                $input.attr('value', this.value);
                $input.css('background-size', this.value * 100.0 / max + '% 100%');

                if ($.isFunction(callback)) {
                    callback(this);
                }
            });
        };



        var change1 = function ($input) {
            $("#txtl1").val($input.value);
        }
        var change2 = function ($input) {
            $("#txtl2").val($input.value);
        }
        var change3 = function ($input) {
            $("#txtl3").val($input.value);
        }
        var change4 = function ($input) {
            $("#txtl4").val($input.value);
        }
        var change5 = function ($input) {
            $("#txtl5").val($input.value);
        }
        var change6 = function ($input) {
            $("#txtl6").val($input.value);
        }
        var change7 = function ($input) {
            $("#txtl7").val($input.value);
        }

        function txtl1change() {
            let val = $("#txtl1").val();
            $("#rangerl1").val(val);
        }

        function txtl2change() {
            let val = $("#txtl2").val();
            $("#rangerl2").val(val);
        }

        function txtl3change() {
            let val = $("#txtl3").val();
            $("#rangerl3").val(val);
        }

        function txtl4change() {
            let val = $("#txtl4").val();
            $("#rangerl4").val(val);
        }

        function txtl5change() {
            let val = $("#txtl5").val();
            $("#rangerl5").val(val);
        }

        function txtl6change() {
            let val = $("#txtl6").val();
            $("#rangerl6").val(val);
        }

        function txtl7change() {
            let val = $("#txtl7").val();
            $("#rangerl7").val(val);
        }

        function save() {
            let openid = "{{userinfo.openid}}";
            let lightinfo = {
                openid: "{{userinfo.openid}}",
                lights: [{ lid: 1, tag: $("#hidselecttimepoint").val(), tagvalue: $("#txtl1").val() },
                { lid: 2, tag: $("#hidselecttimepoint").val(), tagvalue: $("#txtl2").val() },
                { lid: 3, tag: $("#hidselecttimepoint").val(), tagvalue: $("#txtl3").val() },
                { lid: 4, tag: $("#hidselecttimepoint").val(), tagvalue: $("#txtl4").val() },
                { lid: 5, tag: $("#hidselecttimepoint").val(), tagvalue: $("#txtl5").val() },
                { lid: 6, tag: $("#hidselecttimepoint").val(), tagvalue: $("#txtl6").val() },
                { lid: 7, tag: $("#hidselecttimepoint").val(), tagvalue: $("#txtl7").val() }]
            }
            $.ajax({
                type: "POST",
                contentType: "application/json",
                url: "/updatelightdetail",
                data: JSON.stringify(lightinfo),
                dataType: 'json',
                success: (res) => {
                    alert(res == true ? "保存成功" : "保存失败");
                }
            });
        }

        function back() {
            window.location = "https://open.weixin.qq.com/connect/oauth2/authorize?appid={{appid}}&redirect_uri=http://{{domain}}/repeat&response_type=code&scope=snsapi_userinfo&state=STATE#wechat_redirect";
        }

        function tagchange() {
            let params = {
                openid: "{{userinfo.openid}}",
                tag: $("#hidselecttimepoint").val()
            }
            $.ajax({
                type: "POST",
                contentType: "application/json",
                url: "/gettagvalue",
                data: JSON.stringify(params),
                dataType: 'json',
                success: (res) => {
                    let cl1 = res.result.l1;
                    cl1 = Number(cl1);
                    let cl2 = res.result.l2;
                    cl2 = Number(cl2);
                    let cl3 = res.result.l3;
                    cl3 = Number(cl3);
                    let cl4 = res.result.l4;
                    cl4 = Number(cl4);
                    let cl5 = res.result.l5;
                    cl5 = Number(cl5);
                    let cl6 = res.result.l6;
                    cl6 = Number(cl6);
                    let cl7 = res.result.l7;
                    cl7 = Number(cl7);
                    $("#txtl1").val(cl1);
                    $("#txtl2").val(cl2);
                    $("#txtl3").val(cl3);
                    $("#txtl4").val(cl4);
                    $("#txtl5").val(cl5);
                    $("#txtl6").val(cl6);
                    $("#txtl7").val(cl7);
                    $("#rangerl1").val(cl1);
                    $("#rangerl2").val(cl2);
                    $("#rangerl3").val(cl3);
                    $("#rangerl4").val(cl4);
                    $("#rangerl5").val(cl5);
                    $("#rangerl6").val(cl6);
                    $("#rangerl7").val(cl7);
                }
            });
        }

        $('#rangerl1').RangeSlider({ min: 0, max: 100, step: 1, callback: change1 });
        $('#rangerl2').RangeSlider({ min: 0, max: 100, step: 1, callback: change2 });
        $('#rangerl3').RangeSlider({ min: 0, max: 100, step: 1, callback: change3 });
        $('#rangerl4').RangeSlider({ min: 0, max: 100, step: 1, callback: change4 });
        $('#rangerl5').RangeSlider({ min: 0, max: 100, step: 1, callback: change5 });
        $('#rangerl6').RangeSlider({ min: 0, max: 100, step: 1, callback: change6 });
        $('#rangerl7').RangeSlider({ min: 0, max: 100, step: 1, callback: change7 });


        let tag = "{{tag}}";
        $("#hidselecttimepoint").val(tag);
        let timestring = TIMEDEFINE[tag];
        $("#selecttimepoint").val(timestring);

        let l1arr = "{{tagvalues.l1}}".split(',');
        let l1res = l1arr[tag];
        l1res = Number(l1res);
        $("#txtl1").val(l1res);

        let l2arr = "{{tagvalues.l2}}".split(',');
        let l2res = l2arr[tag];
        l2res = Number(l2res);
        $("#txtl2").val(l2res);

        let l3arr = "{{tagvalues.l3}}".split(',');
        let l3res = l3arr[tag];
        l3res = Number(l3res);
        $("#txtl3").val(l3res);

        let l4arr = "{{tagvalues.l4}}".split(',');
        let l4res = l4arr[tag];
        l4res = Number(l4res);
        $("#txtl4").val(l4res);


        let l5arr = "{{tagvalues.l5}}".split(',');
        let l5res = l5arr[tag];
        l5res = Number(l5res);
        $("#txtl5").val(l5res);


        let l6arr = "{{tagvalues.l6}}".split(',');
        let l6res = l6arr[tag];
        l6res = Number(l6res);
        $("#txtl6").val(l6res);


        let l7arr = "{{tagvalues.l7}}".split(',');
        let l7res = l7arr[tag];
        l7res = Number(l7res);
        $("#txtl7").val(l7res);


        $("#rangerl1").val(l1res);
        $("#rangerl2").val(l2res);
        $("#rangerl3").val(l3res);
        $("#rangerl4").val(l4res);
        $("#rangerl5").val(l5res);
        $("#rangerl6").val(l6res);
        $("#rangerl7").val(l7res);


        // function del() {
        //     let delinfo = {
        //         openid: "{{userinfo.openid}}",
        //         tag: $("#hidselecttimepoint").val()
        //     }

        //     $.ajax({
        //         type: "POST",
        //         contentType: "application/json",
        //         url: "/deletetag",
        //         data: JSON.stringify(delinfo),
        //         dataType: 'json',
        //         success: (res) => {
        //             alert(res.result == true ? "删除成功" : "删除失败");
        //             window.location = "https://open.weixin.qq.com/connect/oauth2/authorize?appid={{appid}}&redirect_uri=http://{{domain}}/repeat&response_type=code&scope=snsapi_userinfo&state=STATE#wechat_redirect";
        //         }
        //     });
        // }

        $(function () {
            $("#selecttimepoint").picker({
                title: "选择时间点",
                toolbarCloseText: '确定',
                cols: [
                    {
                        textAlign: 'center',
                        values: TIMEDEFINE,
                        displayValues: TIMEDEFINE
                    }
                ]
            });
        });
    </script>
</body>
</head>